<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“š ë‚˜ì˜ ì½˜í…ì¸  ë‹¤ì´ì–´ë¦¬</title>
    <style>
        *{ margin: 0; padding: 0; }
        body{ font-family: 'Arial', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 1rem; }
        #page-wrapper1{ max-width: 53.7rem; margin: 1rem auto; padding: 0.6rem; background: white; border-radius: 1.2rem; box-shadow: 0px 2px 6px rgba(100, 100, 100, 0.3); }
        #page-wrapper2{ max-width: 48rem; margin: 2rem auto; padding: 1.5rem; background: #f8f9fa; border: 0.17rem solid #e9ecef; border-radius: 1rem; }
        #page-wrapper3{ max-width: 48rem; margin: 1.5rem auto; padding: 1.6rem; background: #e3f2fd; border: none; border-radius: 0.7rem; }
        h1{ text-align: center; font-size: 2.5rem; margin-top: 1.5rem; }
        .fx{ display: flex; align-items: center; gap: 1.7rem; }
        .fx2{ display: flex; align-items: center; }
        .fx, .fx2{ margin-bottom: 1rem; }
        .fx input, .fx select, .fx textarea{ flex: 1; font-size: 1rem; padding: 0.8rem; border: 0.15rem solid #dee2e6; border-radius: 0.5rem; }
        #plus{ font-size: 1rem; color: white; background: linear-gradient(45deg, #667eea, #764ba2); width: 100%; margin-top: 0.9rem; border: none; padding: 0.8rem; border-radius: 2rem; cursor: pointer; transition: all 0.3s ease; }
        #plus:hover{ transform: translateY(-2px); box-shadow: 0 0.01rem 1.5rem rgba(102, 126, 234, 0.4); }
        .page-box1{ display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; text-align: center; }
        .page-box2{ background-color: white; padding: 1rem; border-radius: 0.5rem; box-shadow: 0 0.2rem 0.4rem rgba(0, 0, 0, 0.1); }
        .num{ font-size: 2rem; font-weight: bold; color: #667eea }
        .num-text{ color: #666; font-size: 0.9rem; margin-top: 0.2rem; }
        #btn-all{ text-align: center; margin-bottom: 1.5rem; }
        .btn.frist, .btn:hover{ background-color: #667eea; color: white; }
        .btn{ background-color: white; color: #667eea; border: 0.15rem solid #667eea; padding: 0.4rem 0.8rem; border-radius: 2rem; cursor: pointer; margin: 0 0.3rem; transition: all 0.3s ease; }
        .delete-btn { background: none; border: none; font-size: 1.3rem; cursor: pointer; padding: 0.2rem 0.4rem; margin-left: 0.5rem; }
        #line{ color: #333; margin-bottom: 1rem; padding-bottom: 0.7rem; border-bottom: 0.15rem solid #f0f0f0; }
        .star{ cursor: pointer; font-size: 1.3rem; }
        .fx3{ display: flex; justify-content: space-between; align-items: center; }
        @media (max-width: 768px) {
            #page-wrapper1, #page-wrapper2, #page-wrapper3 { width: 95%; max-width: none;  padding: 1rem; margin: 1rem auto; box-sizing: border-box; }
            h1 { font-size: 1.8rem; }
            .fx { flex-direction: column; align-items: flex-start; gap: 0.5rem; }
            .fx input, .fx select, .fx textarea { width: 100%; box-sizing: border-box; }
            #btn-all .btn { margin-bottom: 0.5rem; }
            .page-box1 { grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); }
        }
    </style>
</head>
<body>
    <div id="page-wrapper1">
        <h1 style="color: #333;">ğŸ“š ë‚˜ì˜ ì½˜í…ì¸  ë‹¤ì´ì–´ë¦¬</h1>
        <div id="page-wrapper2">
            <form id="diary-form">
                <div class="fx">
                    <div style="margin-right: 2rem; font-weight: bold; color: #495057;">ì œëª©:</div> <input type="text" placeholder="ì˜í™”, ë“œë¼ë§ˆ, ì›¹íˆ° ,ì±… ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" required>
                </div>
                <div class="fx">
                    <div style="margin-right: 2rem; font-weight: bold; color: #495057;">ì¢…ë¥˜:</div>
                    <select required>
                        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        <option value="movie">ğŸ¬ ì˜í™”</option>
                        <option value="drama">ğŸ“º ë“œë¼ë§ˆ</option>
                        <option value="webtoon">ğŸ“± ì›¹íˆ°</option>
                        <option value="book">ğŸ“– ì±…</option>
                    </select>
                </div>
                <div class="fx">
                    <div style="margin-right: 2rem; font-weight: bold; color: #495057;">ë‚ ì§œ:</div> <input type="date" id="dt" required>
                </div>
                <div class="fx2">
                    <div style="margin-right: 3.7rem; font-weight: bold; color: #495057;">í‰ì :</div>
                    <div class="star-rating">
                        <span class="star" data-rating="1">â˜†</span>
                        <span class="star" data-rating="2">â˜†</span>
                        <span class="star" data-rating="3">â˜†</span>
                        <span class="star" data-rating="4">â˜†</span>
                        <span class="star" data-rating="5">â˜†</span>
                        <span id="rating-text">(í‰ì ì„ ì„ íƒí•˜ì„¸ìš”)</span>
                    </div>
                </div>
                <div class="fx">
                    <div style="margin-right: 2rem; font-weight: bold; color: #495057;">ë©”ëª¨:</div> <textarea placeholder="ê°ìƒí‰ì´ë‚˜ ê¸°ì–µí•˜ê³  ì‹¶ì€ ë‚´ìš©ì„ ì ì–´ë³´ì„¸ìš”..." style="height: 3rem;"></textarea>
                </div>
                <input type="submit" id="plus" value="ğŸ“ ë‹¤ì´ì–´ë¦¬ ì¶”ê°€í•˜ê¸°">
            </form>
        </div>
        <div id="page-wrapper3">
            <h3 style="text-align: center; margin-bottom: 1.2rem;">ğŸ“Š ë‚˜ì˜ ì½˜í…ì¸  í†µê³„</h3>
            <div class="page-box1">
                <div class="page-box2">
                    <div class="num">0</div>
                    <div class="num-text">ì´ ê°œìˆ˜</div>
                </div>
                <div class="page-box2">
                    <div class="num">0.0</div>
                    <div class="num-text">í‰ê·  í‰ì </div>
                </div>
                <div class="page-box2">
                    <div class="num">0</div>
                    <div class="num-text">ì´ë²ˆ ë‹¬</div>
                </div>
                <div class="page-box2">
                    <div class="num">-</div>
                    <div class="num-text">ìµœì•  ì¥ë¥´</div>
                </div>
            </div>
        </div>
        <div id="btn-all">
            <button class="btn frist">ì „ì²´</button>
            <button class="btn">ğŸ¬ ì˜í™”</button>
            <button class="btn">ğŸ“º ë“œë¼ë§ˆ</button>
            <button class="btn">ğŸ“± ì›¹íˆ°</button>
            <button class="btn">ğŸ“– ì±…</button>
        </div>
        <div style="margin-left: 1rem; margin-right: 1rem; margin-bottom: 1rem;">
            <h3 id="line">ğŸ“– ë‚´ê°€ ë³¸ ì½˜í…ì¸ ë“¤</h3>
            <div id="empty" style="text-align: center; font-size: 1rem;">
                <div style="font-size: 3rem;">ğŸ“</div>
                <p>ì•„ì§ ê¸°ë¡ëœ ì½˜í…ì¸ ê°€ ì—†ì–´ìš”!</p>
                <p>ìœ„ì—ì„œ ì²« ë²ˆì§¸ ë‹¤ì´ì–´ë¦¬ë¥¼ ì‘ì„±í•´ë³´ì„¸ìš” ğŸ˜Š</p>
            </div>
            <div id="diary-list"></div>
        </div>
    </div>

<script>
    const API_URL = 'http://localhost:3000/api/diaries';
    document.getElementById("dt").valueAsDate = new Date();
    let selectedRating = 0;

    document.addEventListener('DOMContentLoaded', fetchDiaries);
    document.getElementById("diary-form").addEventListener("submit", handleFormSubmit);
    
    document.querySelectorAll("#diary-form .star").forEach(star => {
        star.addEventListener("click", function () {
            selectedRating = parseInt(this.dataset.rating);
            updateStarDisplay(selectedRating, "#diary-form .star-rating");
        });
    });

    async function fetchDiaries() {
        try {
            const response = await fetch(API_URL);
            if (!response.ok) throw new Error('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜');
            const diaries = await response.json();
            const diaryList = document.getElementById("diary-list");
            const emptyMessage = document.getElementById("empty");
            diaryList.innerHTML = ''; 

            if (diaries.length === 0) {
                emptyMessage.style.display = "block";
            } else {
                emptyMessage.style.display = "none";
                diaries.forEach(diary => {
                    const diaryElement = createDiaryElement(diary);
                    diaryList.appendChild(diaryElement);
                });
            }
            updateStats(diaries);
        } catch (error) {
            console.error('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
            alert('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    }

    async function handleFormSubmit(e) {
        e.preventDefault();
        const newDiary = {
            title: document.querySelector("#diary-form input[type='text']").value,
            type: document.querySelector("#diary-form select").options[document.querySelector("#diary-form select").selectedIndex].text,
            date: document.querySelector("#diary-form input[type='date']").value,
            rating: selectedRating,
            memo: document.querySelector("#diary-form textarea").value
        };

        if (!newDiary.title || !newDiary.type || !newDiary.date || newDiary.rating === 0) {
            alert("ì œëª©, ì¢…ë¥˜, ë‚ ì§œ, í‰ì ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(newDiary)
            });
            if (!response.ok) throw new Error('ë°ì´í„° ì €ì¥ ì‹¤íŒ¨');
            fetchDiaries(); 
            resetForm(); 
        } catch (error) {
            console.error('ë°ì´í„° ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
            alert('ë°ì´í„° ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // â­ï¸ ì´ í•¨ìˆ˜ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.
    function createDiaryElement(diary) {
        const main = document.createElement("div");
        main.className = "fx3";
        
        // ì£¼ì„: í…œí”Œë¦¿ ë¦¬í„°ëŸ´ì„ ì‚¬ìš©í•´ ë‹¤ì´ì–´ë¦¬ í•­ëª©ì˜ HTML êµ¬ì¡°ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.
        main.innerHTML = `
            <div style="flex-grow: 1;">
                <strong>${diary.type}</strong> ${diary.title} (${new Date(diary.date).toLocaleDateString()})<br>
                <div class="star-rating-display">
                    í‰ì : 
                    <span class="star">â˜†</span><span class="star">â˜†</span><span class="star">â˜†</span><span class="star">â˜†</span><span class="star">â˜†</span>
                </div>
                ë©”ëª¨: ${diary.memo || "(ì—†ìŒ)"}
            </div>
            <button class="delete-btn" data-id="${diary._id}">ğŸ—‘ï¸</button>
        `;
        
        // â­ï¸ ì´ ë¶€ë¶„ì´ í•µì‹¬ì ì¸ ìˆ˜ì • ì‚¬í•­ì…ë‹ˆë‹¤.
        // ì£¼ì„: ìœ„ì—ì„œ ìƒì„±í•œ HTML ìš”ì†Œ(main) ì•ˆì—ì„œ ë³„ì  ì˜ì—­('.star-rating-display')ì„ ì§ì ‘ ì°¾ìŠµë‹ˆë‹¤.
        // ê·¸ë¦¬ê³  ê·¸ ì•ˆì˜ ë³„ë“¤ì—ê²Œ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ê°€ì ¸ì˜¨ í‰ì (diary.rating)ì„ ë°”ë¡œ ì ìš©í•©ë‹ˆë‹¤.
        // ì´ë ‡ê²Œ í•˜ë©´ ë‹¤ë¥¸ ê³³ê³¼ ì¶©ëŒ ì—†ì´ í•´ë‹¹ í•­ëª©ì˜ ë³„ì ë§Œ ì •í™•í•˜ê²Œ ì±„ìš¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        const starContainer = main.querySelector('.star-rating-display');
        const stars = starContainer.querySelectorAll('.star');
        stars.forEach((star, index) => {
            star.textContent = index < diary.rating ? 'â˜…' : 'â˜†';
        });

        // ì‚­ì œ ë²„íŠ¼ì— í´ë¦­ ì´ë²¤íŠ¸ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
        main.querySelector(".delete-btn").addEventListener("click", async function() {
            const diaryId = this.dataset.id;
            if (confirm('ì •ë§ë¡œ ì´ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                try {
                    const response = await fetch(`${API_URL}/${diaryId}`, { method: 'DELETE' });
                    if (!response.ok) throw new Error('ë°ì´í„° ì‚­ì œ ì‹¤íŒ¨');
                    fetchDiaries(); 
                } catch (error) {
                    console.error('ë°ì´í„° ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
                    alert('ë°ì´í„° ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            }
        });

        main.style.cssText = "padding: 1rem; background: white; margin-bottom: 1rem; border-radius: 0.7rem; box-shadow: 0 2px 6px rgba(0,0,0,0.1);";
        return main;
    }

    function resetForm() {
        document.getElementById("diary-form").reset();
        document.getElementById("dt").valueAsDate = new Date();
        selectedRating = 0;
        updateStarDisplay(0, "#diary-form .star-rating");
    }
    
    function updateStarDisplay(rating, parentSelector) {
        const parentElement = document.querySelector(parentSelector);
        if (parentElement) {
            const stars = parentElement.querySelectorAll(".star");
            stars.forEach((star, index) => {
                star.textContent = index < rating ? "â˜…" : "â˜†";
            });

            if (parentSelector.includes("#diary-form")) {
                const ratingText = document.getElementById("rating-text");
                if (ratingText) {
                    ratingText.textContent = rating > 0 ? `(${rating}ì )` : "(í‰ì ì„ ì„ íƒí•˜ì„¸ìš”)";
                }
            }
        }
    }

    function updateStats(diaries) {
        const total = diaries.length;
        let totalScore = 0;
        let monthCount = 0;
        const genreCount = {};
        const thisMonth = new Date().getMonth();
        const thisYear = new Date().getFullYear();

        diaries.forEach(item => {
            totalScore += item.rating;
            const writtenDate = new Date(item.date);
            if (writtenDate.getFullYear() === thisYear && writtenDate.getMonth() === thisMonth) { monthCount++; }
            genreCount[item.type] = (genreCount[item.type] || 0) + 1;
        });

        const avg = total ? (totalScore / total).toFixed(1) : "0.0";
        const favoriteGenre = Object.entries(genreCount).sort((a, b) => b[1] - a[1])[0]?.[0] || "-";

        const statsElements = document.querySelectorAll(".page-box1 .num");
        statsElements[0].textContent = total;
        statsElements[1].textContent = avg;
        statsElements[2].textContent = monthCount;
        statsElements[3].textContent = favoriteGenre;
    }
</script>
</body>
</html>
